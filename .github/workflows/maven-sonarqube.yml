name: Maven Build with Docker and SonarQube

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Shallow clones should be disabled for better analysis relevancy

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: Cache SonarCloud packages
        uses: actions/cache@v4
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar

      - name: Cache Maven packages
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2

      - name: Build and analyze with Maven
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}    
          SONAR_TOKEN: ${{ secrets.SONARQUBE_TOKEN }}
        run: |
          ./mvnw -B verify  \
            -Dsonar.host.url=https://sonarcloud.io -Dsonar.organization=golantrevize10 -Dsonar.projectKey=GolanTrevize10_spring-petclinic

      - name: ServiceNow DevOps Sonar Scan Results
        uses: ServiceNow/servicenow-devops-sonar@v3.1.0
        with:
          devops-integration-token: ${{ secrets.SN_DEVOPS_INTEGRATION_TOKEN}}
          instance-url: ${{ secrets.SN_INSTANCE_URL }}
          tool-id: ${{ secrets.SN_ORCHESTRATION_TOOL_ID }}
          context-github: ${{ toJSON(github) }}
          job-name: 'Build'
          sonar-host-url: ${{ secrets.SONAR_URL }}
          sonar-project-key: ${{ secrets.SONAR_PROJECT_KEY }}    

      # Build image and give it the fully-qualified JFrog name
      - name: Build Docker image with Spring Boot (image named for JFrog)
        env:
          IMAGE_NAME: ${{ secrets.JFROG_REGISTRY }}/${{ secrets.JFROG_REPO }}/petclinic:${{ github.sha }}
        run: |
          echo "Image name: $IMAGE_NAME"
          # Buildpacks will create an image in the local docker daemon with this name
          ./mvnw spring-boot:build-image -DskipTests -Dspring-boot.build-image.imageName=$IMAGE_NAME

      - name: Log in to JFrog Docker registry
        uses: docker/login-action@v2
        with:
          registry: ${{ secrets.JFROG_REGISTRY }}
          username: ${{ secrets.JFROG_USERNAME }}
          password: ${{ secrets.JFROG_PASSWORD }}

      - name: Push image to JFrog Artifactory
        env:
          IMAGE_NAME: ${{ secrets.JFROG_REGISTRY }}/${{ secrets.JFROG_REPO }}/petclinic:${{ github.sha }}
        run: |
          echo "Pushing $IMAGE_NAME"
          docker push $IMAGE_NAME

      - name: ServiceNow Register Artifact
        uses: ServiceNow/servicenow-devops-register-artifact@v3.1.0
        with:
          devops-integration-token: ${{ secrets.SN_DEVOPS_INTEGRATION_TOKEN }}
          instance-url: ${{ secrets.SN_INSTANCE_URL }}
          tool-id: ${{ secrets.SN_ORCHESTRATION_TOOL_ID }}
          context-github: ${{ toJSON(github) }}
          job-name: 'Register Artifact'
          artifacts: '[{"name": "${{ secrets.JFROG_REGISTRY }}/${{ secrets.JFROG_REPO }}/petclinic:${{ github.sha }}","version": "1.${{ github.run_number }}","semanticVersion": "1.${{ github.run_number }}.0","repositoryName": "${{ github.repository }}"}]'
  ServiceNowDevOpsChange:
        # jobs that must complete successfully before this job will run
        needs: build
        # type of machine to run the job on
        runs-on: ubuntu-latest
        name: 'ServiceNow DevOps Change'
        steps:
          - name: ServiceNow Change
            # Ensure to update to the latest version of the custom action, for e.g. ServiceNow/servicenow-devops-change@v5.1.0
            uses: ServiceNow/servicenow-devops-change@v6.1.0
            with:
              # Devops Integration Token
              devops-integration-token: ${{ secrets.SN_DEVOPS_INTEGRATION_TOKEN }}
              # ServiceNow Instance URL
              instance-url: ${{ secrets.SN_INSTANCE_URL }}
              # Orchestration Tool Id
              tool-id: ${{ secrets.SN_ORCHESTRATION_TOOL_ID }}
              # GitHub Context
              context-github: ${{ toJSON(github) }}
              # Display Name of the Job
              job-name: 'ServiceNow DevOps Change'

  deployment:
      runs-on: ubuntu-latest
      needs: ServiceNowDevOpsChange
      steps:
      - name: Simulate deployment
        run: |
          echo "Deploying artifact to DEV environment"
          sleep 5
